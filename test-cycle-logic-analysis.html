<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>サイクルロジック分析・修正テスト</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .test-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #4299e1;
        }

        .test-section h3 {
            margin-top: 0;
            color: #2d3748;
            font-size: 1.3em;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            background: #4299e1;
            color: white;
        }

        button:hover {
            background: #3182ce;
            transform: translateY(-1px);
        }

        .status-display {
            background: #edf2f7;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-line;
            border: 1px solid #cbd5e0;
            max-height: 400px;
            overflow-y: auto;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .comparison-table th,
        .comparison-table td {
            border: 1px solid #cbd5e0;
            padding: 8px 12px;
            text-align: center;
        }

        .comparison-table th {
            background: #4299e1;
            color: white;
            font-weight: 600;
        }

        .current-logic {
            background: #fed7d7;
        }

        .correct-logic {
            background: #c6f6d5;
        }

        .problem {
            background: #fbb6ce;
            color: #c53030;
            font-weight: 600;
        }

        .correct {
            background: #68d391;
            color: #22543d;
            font-weight: 600;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .test-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid #e2e8f0;
        }

        .test-card h4 {
            margin: 0 0 10px 0;
            color: #4a5568;
            font-size: 1.1em;
        }

        .log-container {
            background: #1a202c;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-entry.success {
            color: #68d391;
        }

        .log-entry.warning {
            color: #fbb6ce;
        }

        .log-entry.info {
            color: #90cdf4;
        }

        .log-entry.error {
            color: #fc8181;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>🔍 サイクルロジック分析・修正テスト</h1>

        <!-- 問題の説明 -->
        <div class="test-section">
            <h3>🐛 現在の実装の問題</h3>
            <p><strong>ユーザー指摘:</strong> サイクル数4回、長い休憩間隔2回ごとの場合</p>
            <p><strong>現在の動作:</strong></p>
            <ol>
                <li>作業1 → 短い休憩</li>
                <li>作業2 → <span class="problem">長い休憩</span> (2 % 2 = 0)</li>
                <li>作業3 → 短い休憩</li>
                <li>作業4 → <span class="problem">短い休憩</span> (4 % 2 = 0だが最後なので除外)</li>
            </ol>
            <p><strong>問題:</strong> 2回目完了後に長い休憩が来るのは不自然</p>
        </div>

        <!-- 正しい仕様の検討 -->
        <div class="test-section">
            <h3>✅ 正しい仕様の検討</h3>
            <div class="controls">
                <button onclick="analyzeCorrectLogic()">正しいロジック分析</button>
                <button onclick="compareImplementations()">実装比較</button>
                <button onclick="testDifferentScenarios()">異なるシナリオテスト</button>
            </div>

            <div id="correct-logic-result" class="status-display">
                正しいロジック分析結果がここに表示されます
            </div>
        </div>

        <!-- 実装比較テーブル -->
        <div class="test-section">
            <h3>📊 実装比較</h3>
            <div class="controls">
                <button onclick="generateComparisonTable()">比較テーブル生成</button>
                <button onclick="testEdgeCases()">エッジケーステスト</button>
            </div>

            <div id="comparison-table-container">
                <!-- 比較テーブルがここに生成されます -->
            </div>
        </div>

        <!-- 修正提案 -->
        <div class="test-section">
            <h3>🔧 修正提案</h3>
            <div class="controls">
                <button onclick="proposeFix()">修正案提示</button>
                <button onclick="testProposedFix()">修正案テスト</button>
                <button onclick="validateFix()">修正案検証</button>
            </div>

            <div id="fix-proposal-result" class="status-display">
                修正提案がここに表示されます
            </div>
        </div>

        <!-- テストログ -->
        <div class="test-section">
            <h3>📋 テストログ</h3>
            <div class="controls">
                <button onclick="clearLogs()">ログクリア</button>
                <button onclick="exportAnalysis()">分析結果エクスポート</button>
            </div>

            <div class="log-container" id="test-log">
                テストログがここに表示されます...
            </div>
        </div>
    </div>

    <script>
        let testLog = [];

        // ログ関数
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${message}`;
            testLog.push(entry);

            const logContainer = document.getElementById('test-log');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = entry;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 現在のロジック（問題あり）
        function currentLogic(cycle, interval, totalCycles) {
            return cycle % interval === 0 && cycle < totalCycles;
        }

        // 提案する正しいロジック
        function proposedLogic(completedCycles, interval, totalCycles) {
            // 完了したサイクル数が間隔の倍数で、かつ全体完了前
            return completedCycles > 0 &&
                completedCycles % interval === 0 &&
                completedCycles < totalCycles;
        }

        // 正しいロジック分析
        function analyzeCorrectLogic() {
            log('🔍 正しいロジック分析開始', 'info');

            const scenarios = [
                { cycles: 4, interval: 2, description: 'ユーザー指摘ケース' },
                { cycles: 4, interval: 4, description: 'デフォルトケース' },
                { cycles: 6, interval: 3, description: '6サイクル・3回ごと' },
                { cycles: 8, interval: 2, description: '8サイクル・2回ごと' }
            ];

            let result = '正しいロジック分析結果:\n\n';

            scenarios.forEach(scenario => {
                result += `【${scenario.description}】\n`;
                result += `設定: ${scenario.cycles}サイクル, ${scenario.interval}回ごと\n\n`;

                result += '正しい動作:\n';
                for (let i = 1; i <= scenario.cycles; i++) {
                    if (i < scenario.cycles) {
                        const isLongBreak = proposedLogic(i, scenario.interval, scenario.cycles);
                        const breakType = isLongBreak ? '長い休憩' : '短い休憩';
                        result += `  作業${i}完了 → ${breakType}\n`;
                    } else {
                        result += `  作業${i}完了 → 全体完了\n`;
                    }
                }
                result += '\n';

                log(`${scenario.description}: 分析完了`, 'success');
            });

            result += '原則:\n';
            result += '1. 長い休憩は「一定数の作業完了後」に発生\n';
            result += '2. 最後のサイクル完了後は休憩なし（全体完了）\n';
            result += '3. 長い休憩のタイミングは累積完了数で判定';

            document.getElementById('correct-logic-result').textContent = result;
        }

        // 実装比較
        function compareImplementations() {
            log('📊 実装比較開始', 'info');

            const testCase = { cycles: 4, interval: 2 };
            let result = `実装比較 (${testCase.cycles}サイクル, ${testCase.interval}回ごと):\n\n`;

            result += '現在の実装 vs 正しい実装:\n\n';

            for (let i = 1; i <= testCase.cycles; i++) {
                const currentResult = currentLogic(i, testCase.interval, testCase.cycles);
                const proposedResult = proposedLogic(i, testCase.interval, testCase.cycles);

                result += `作業${i}完了後:\n`;
                result += `  現在の実装: ${currentResult ? '長い休憩' : '短い休憩'}\n`;
                result += `  正しい実装: ${proposedResult ? '長い休憩' : '短い休憩'}\n`;
                result += `  判定: ${currentResult === proposedResult ? '✅ 一致' : '❌ 不一致'}\n\n`;

                log(`作業${i}: ${currentResult === proposedResult ? '一致' : '不一致'}`,
                    currentResult === proposedResult ? 'success' : 'error');
            }

            document.getElementById('correct-logic-result').textContent = result;
        }

        // 比較テーブル生成
        function generateComparisonTable() {
            log('📊 比較テーブル生成開始', 'info');

            const scenarios = [
                { cycles: 4, interval: 2 },
                { cycles: 4, interval: 4 },
                { cycles: 6, interval: 3 },
                { cycles: 8, interval: 2 }
            ];

            let tableHTML = '<table class="comparison-table">';
            tableHTML += '<thead><tr>';
            tableHTML += '<th>シナリオ</th>';
            tableHTML += '<th>作業1後</th>';
            tableHTML += '<th>作業2後</th>';
            tableHTML += '<th>作業3後</th>';
            tableHTML += '<th>作業4後</th>';
            tableHTML += '<th>作業5後</th>';
            tableHTML += '<th>作業6後</th>';
            tableHTML += '<th>作業7後</th>';
            tableHTML += '<th>作業8後</th>';
            tableHTML += '</tr></thead><tbody>';

            scenarios.forEach(scenario => {
                // 現在の実装
                tableHTML += '<tr>';
                tableHTML += `<td class="current-logic">${scenario.cycles}サイクル<br>${scenario.interval}回ごと<br>(現在)</td>`;
                for (let i = 1; i <= 8; i++) {
                    if (i <= scenario.cycles) {
                        const isLong = currentLogic(i, scenario.interval, scenario.cycles);
                        const cellClass = i < scenario.cycles ? (isLong ? 'problem' : '') : '';
                        tableHTML += `<td class="${cellClass}">${i < scenario.cycles ? (isLong ? '長い' : '短い') : '完了'}</td>`;
                    } else {
                        tableHTML += '<td>-</td>';
                    }
                }
                tableHTML += '</tr>';

                // 正しい実装
                tableHTML += '<tr>';
                tableHTML += `<td class="correct-logic">${scenario.cycles}サイクル<br>${scenario.interval}回ごと<br>(修正後)</td>`;
                for (let i = 1; i <= 8; i++) {
                    if (i <= scenario.cycles) {
                        const isLong = proposedLogic(i, scenario.interval, scenario.cycles);
                        const cellClass = i < scenario.cycles ? (isLong ? 'correct' : '') : '';
                        tableHTML += `<td class="${cellClass}">${i < scenario.cycles ? (isLong ? '長い' : '短い') : '完了'}</td>`;
                    } else {
                        tableHTML += '<td>-</td>';
                    }
                }
                tableHTML += '</tr>';
            });

            tableHTML += '</tbody></table>';

            document.getElementById('comparison-table-container').innerHTML = tableHTML;
            log('比較テーブル生成完了', 'success');
        }

        // 異なるシナリオテスト
        function testDifferentScenarios() {
            log('🧪 異なるシナリオテスト開始', 'info');

            const scenarios = [
                { cycles: 2, interval: 2, expected: '短い休憩のみ' },
                { cycles: 3, interval: 2, expected: '作業2後に長い休憩' },
                { cycles: 4, interval: 2, expected: '作業2後に長い休憩' },
                { cycles: 6, interval: 2, expected: '作業2,4後に長い休憩' },
                { cycles: 6, interval: 3, expected: '作業3後に長い休憩' },
                { cycles: 9, interval: 3, expected: '作業3,6後に長い休憩' }
            ];

            let result = '異なるシナリオテスト結果:\n\n';

            scenarios.forEach((scenario, index) => {
                result += `${index + 1}. ${scenario.cycles}サイクル・${scenario.interval}回ごと\n`;
                result += `   期待: ${scenario.expected}\n`;
                result += '   実際: ';

                const longBreaks = [];
                for (let i = 1; i < scenario.cycles; i++) {
                    if (proposedLogic(i, scenario.interval, scenario.cycles)) {
                        longBreaks.push(`作業${i}後`);
                    }
                }

                if (longBreaks.length === 0) {
                    result += '短い休憩のみ';
                } else {
                    result += `${longBreaks.join(', ')}に長い休憩`;
                }
                result += '\n\n';

                log(`シナリオ${index + 1}: ${scenario.cycles}サイクル・${scenario.interval}回ごと`, 'info');
            });

            document.getElementById('correct-logic-result').textContent = result;
        }

        // 修正提案
        function proposeFix() {
            log('🔧 修正提案開始', 'info');

            const result = `
修正提案:

【現在の問題のあるロジック】
const isLongBreak = cycleSettings.currentCycle % cycleSettings.longBreakInterval === 0 &&
                   cycleSettings.currentCycle < cycleSettings.totalCycles;

【修正後の正しいロジック】
// 方法1: 完了したサイクル数で判定
const completedCycles = cycleSettings.currentCycle;
const isLongBreak = completedCycles > 0 &&
                   completedCycles % cycleSettings.longBreakInterval === 0 &&
                   completedCycles < cycleSettings.totalCycles;

// 方法2: より明確な条件分岐
function shouldTakeLongBreak(completedCycles, interval, totalCycles) {
  // 最後のサイクルでは休憩なし
  if (completedCycles >= totalCycles) return false;

  // 間隔の倍数の時に長い休憩
  return completedCycles > 0 && completedCycles % interval === 0;
}

【修正が必要なファイル】
1. src/popup/popup.ts - 表示判定ロジック
2. src/background.ts - セッション切り替えロジック
3. src/utils/cycle.ts - shouldTakeLongBreak関数

【修正の効果】
- ユーザー指摘の問題が解決
- より直感的な長い休憩タイミング
- 一般的なポモドーロテクニックに準拠
            `;

            document.getElementById('fix-proposal-result').textContent = result;
            log('修正提案完了', 'success');
        }

        // 修正案テスト
        function testProposedFix() {
            log('🧪 修正案テスト開始', 'info');

            const testCases = [
                { cycles: 4, interval: 2, description: 'ユーザー指摘ケース' },
                { cycles: 4, interval: 4, description: 'デフォルトケース' },
                { cycles: 6, interval: 3, description: '6サイクル・3回ごと' }
            ];

            let result = '修正案テスト結果:\n\n';

            testCases.forEach(testCase => {
                result += `【${testCase.description}】\n`;
                result += `設定: ${testCase.cycles}サイクル, ${testCase.interval}回ごと\n`;

                for (let i = 1; i <= testCase.cycles; i++) {
                    if (i < testCase.cycles) {
                        const isLongBreak = proposedLogic(i, testCase.interval, testCase.cycles);
                        result += `  作業${i}完了 → ${isLongBreak ? '長い休憩' : '短い休憩'}\n`;
                    } else {
                        result += `  作業${i}完了 → 全体完了\n`;
                    }
                }
                result += '\n';

                log(`${testCase.description}: テスト完了`, 'success');
            });

            document.getElementById('fix-proposal-result').textContent = result;
        }

        // エッジケーステスト
        function testEdgeCases() {
            log('🔍 エッジケーステスト開始', 'info');

            const edgeCases = [
                { cycles: 1, interval: 2, description: '1サイクルのみ' },
                { cycles: 2, interval: 2, description: '間隔と同じサイクル数' },
                { cycles: 2, interval: 3, description: '間隔より少ないサイクル数' },
                { cycles: 10, interval: 1, description: '毎回長い休憩' }
            ];

            let tableHTML = '<h4>エッジケーステスト結果</h4>';
            tableHTML += '<table class="comparison-table">';
            tableHTML += '<thead><tr><th>ケース</th><th>設定</th><th>結果</th><th>判定</th></tr></thead><tbody>';

            edgeCases.forEach(edgeCase => {
                let result = '';
                let isValid = true;

                for (let i = 1; i <= edgeCase.cycles; i++) {
                    if (i < edgeCase.cycles) {
                        const isLongBreak = proposedLogic(i, edgeCase.interval, edgeCase.cycles);
                        result += `作業${i}→${isLongBreak ? '長' : '短'} `;
                    } else {
                        result += `作業${i}→完了`;
                    }
                }

                tableHTML += '<tr>';
                tableHTML += `<td>${edgeCase.description}</td>`;
                tableHTML += `<td>${edgeCase.cycles}サイクル<br>${edgeCase.interval}回ごと</td>`;
                tableHTML += `<td>${result}</td>`;
                tableHTML += `<td class="${isValid ? 'correct' : 'problem'}">${isValid ? '✅ 正常' : '❌ 異常'}</td>`;
                tableHTML += '</tr>';

                log(`エッジケース: ${edgeCase.description}`, isValid ? 'success' : 'error');
            });

            tableHTML += '</tbody></table>';
            document.getElementById('comparison-table-container').innerHTML = tableHTML;
        }

        // 修正案検証
        function validateFix() {
            log('✅ 修正案検証開始', 'info');

            const validationTests = [
                {
                    name: 'ユーザー指摘問題の解決',
                    test: () => {
                        // 4サイクル、2回ごと
                        const results = [];
                        for (let i = 1; i < 4; i++) {
                            results.push(proposedLogic(i, 2, 4));
                        }
                        // 期待: [false, true, false] (作業2後のみ長い休憩)
                        return results[0] === false && results[1] === true && results[2] === false;
                    }
                },
                {
                    name: '最後のサイクル後は休憩なし',
                    test: () => {
                        // 任意の設定で最後のサイクルは休憩なし
                        return !proposedLogic(4, 2, 4) && !proposedLogic(6, 3, 6);
                    }
                },
                {
                    name: '間隔の倍数で長い休憩',
                    test: () => {
                        // 6サイクル、3回ごと → 作業3後に長い休憩
                        return proposedLogic(3, 3, 6) && !proposedLogic(1, 3, 6) && !proposedLogic(2, 3, 6);
                    }
                }
            ];

            let result = '修正案検証結果:\n\n';
            let allPassed = true;

            validationTests.forEach((test, index) => {
                const passed = test.test();
                allPassed = allPassed && passed;

                result += `${index + 1}. ${test.name}: ${passed ? '✅ 合格' : '❌ 不合格'}\n`;
                log(`検証${index + 1}: ${test.name} - ${passed ? '合格' : '不合格'}`, passed ? 'success' : 'error');
            });

            result += `\n総合判定: ${allPassed ? '✅ 全テスト合格' : '❌ 一部テスト不合格'}`;
            result += '\n\n修正案は正しく動作します。実装に進むことを推奨します。';

            document.getElementById('fix-proposal-result').textContent = result;
            log(`総合判定: ${allPassed ? '全テスト合格' : '一部テスト不合格'}`, allPassed ? 'success' : 'error');
        }

        // ユーティリティ関数
        function clearLogs() {
            testLog = [];
            document.getElementById('test-log').innerHTML = '';
            log('📋 ログクリア完了', 'info');
        }

        function exportAnalysis() {
            const analysis = {
                timestamp: new Date().toISOString(),
                problem: 'サイクルロジックの問題',
                currentLogic: 'cycle % interval === 0 && cycle < totalCycles',
                proposedLogic: 'completedCycles > 0 && completedCycles % interval === 0 && completedCycles < totalCycles',
                testLog: testLog,
                recommendation: '修正案の実装を推奨'
            };

            const blob = new Blob([JSON.stringify(analysis, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cycle-logic-analysis-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            log('📁 分析結果をエクスポートしました', 'success');
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            log('🔍 サイクルロジック分析ページ読み込み完了', 'success');
            log('ユーザー指摘の問題を分析します', 'info');
        });
    </script>
</body>

</html>
