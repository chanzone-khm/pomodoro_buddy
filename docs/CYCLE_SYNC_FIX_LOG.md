# ã‚µã‚¤ã‚¯ãƒ«åŒæœŸãƒ»é•·ã„ä¼‘æ†©åˆ¤å®šä¿®æ­£è¨˜éŒ²

## ğŸ“‹ ä¿®æ­£æ¦‚è¦

**ä¿®æ­£æ—¥**: 2024å¹´12æœˆ19æ—¥
**å ±å‘Šè€…**: ãƒ¦ãƒ¼ã‚¶ãƒ¼
**å•é¡Œ**: ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§ã‚µã‚¤ã‚¯ãƒ«æ•°ãŒé€²è¡Œã›ãšã€é•·ã„ä¼‘æ†©ãŒè¡¨ç¤ºã•ã‚Œãªã„

## ğŸ› ç™ºè¦‹ã•ã‚ŒãŸå•é¡Œ

### å•é¡Œ1: ã‚µã‚¤ã‚¯ãƒ«æ•°ãŒé€²è¡Œã—ãªã„

**ç—‡çŠ¶**:
- ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§ä½œæ¥­â†’ä¼‘æ†©ã‚’ç¹°ã‚Šè¿”ã—ã¦ã‚‚ã€Œ1/4ã‚µã‚¤ã‚¯ãƒ«ã€ã®ã¾ã¾
- ã‚µã‚¤ã‚¯ãƒ«é€²è¡ŒçŠ¶æ³ãŒæ›´æ–°ã•ã‚Œãªã„

**åŸå› **:
- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å´ã®`cycleSettings`ãŒãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã®å®Ÿéš›ã®ã‚µã‚¤ã‚¯ãƒ«çŠ¶æ…‹ã¨åŒæœŸã—ã¦ã„ãªã„
- `fetchTimerState()`ã§ã‚µã‚¤ã‚¯ãƒ«è¨­å®šã‚’å–å¾—ã—ã¦ã„ãªã‹ã£ãŸ

### å•é¡Œ2: é•·ã„ä¼‘æ†©ãŒè¡¨ç¤ºã•ã‚Œãªã„

**ç—‡çŠ¶**:
- 4å›ç›®ã®ã‚µã‚¤ã‚¯ãƒ«å®Œäº†å¾Œã‚‚ã€ŒçŸ­ã„ä¼‘æ†©ä¸­ã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹
- é•·ã„ä¼‘æ†©ã®é’è‰²è¡¨ç¤ºãŒå‡ºãªã„

**åŸå› **:
- é•·ã„ä¼‘æ†©åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ãŒè¤‡é›‘ã§ä¸æ­£ç¢º
- `shouldTakeLongBreak()`é–¢æ•°ã®æ¡ä»¶ãŒé©åˆ‡ã§ãªã„

## ğŸ”§ å®Ÿè£…ã•ã‚ŒãŸä¿®æ­£

### ä¿®æ­£1: ã‚µã‚¤ã‚¯ãƒ«åŒæœŸã®æ”¹å–„

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/background.ts`
```typescript
case MessageAction.GET_STATE:
  sendResponse({
    state: currentState,
    settings: settings,
    remainingTime: calculateRemainingTime(currentState),
    cycleSettings: cycleSettings  // è¿½åŠ 
  });
  break;
```

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/popup/popup.ts`
```typescript
async function fetchTimerState() {
  return new Promise<void>((resolve) => {
    chrome.runtime.sendMessage(
      { action: MessageAction.GET_STATE },
      (response) => {
        if (response) {
          timerState = response.state;
          timerSettings = response.settings;
          remainingTime = response.remainingTime;

          // ã‚µã‚¤ã‚¯ãƒ«è¨­å®šã‚‚åŒæœŸ
          if (response.cycleSettings) {
            cycleSettings = response.cycleSettings;
          }

          resolve();
        }
      }
    );
  });
}
```

### ä¿®æ­£2: é•·ã„ä¼‘æ†©åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã®ç°¡ç´ åŒ–

**ä¿®æ­£å‰**:
```typescript
const isLongBreak = shouldTakeLongBreak(cycleSettings, SessionType.Work) &&
                   cycleSettings.currentCycle % cycleSettings.longBreakInterval === 0;
```

**ä¿®æ­£å¾Œ**:
```typescript
// ç¾åœ¨ã®ã‚µã‚¤ã‚¯ãƒ«ãŒé•·ã„ä¼‘æ†©é–“éš”ã®å€æ•°ã‹ã©ã†ã‹ã§åˆ¤å®š
const isLongBreak = cycleSettings.currentCycle % cycleSettings.longBreakInterval === 0 &&
                   cycleSettings.currentCycle < cycleSettings.totalCycles;
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆå†…å®¹

### ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
- `test-cycle-sync-fix.html`: ä¿®æ­£å†…å®¹ã‚’åŒ…æ‹¬çš„ã«ãƒ†ã‚¹ãƒˆã™ã‚‹ãƒšãƒ¼ã‚¸

### ãƒ†ã‚¹ãƒˆé …ç›®

#### 1. ã‚µã‚¤ã‚¯ãƒ«åŒæœŸãƒ†ã‚¹ãƒˆ
- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã¨ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã®çŠ¶æ…‹åŒæœŸç¢ºèª
- ã‚µã‚¤ã‚¯ãƒ«é€²è¡Œã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- åŒæœŸçŠ¶æ…‹ã®å¯è¦–åŒ–

#### 2. é•·ã„ä¼‘æ†©åˆ¤å®šãƒ†ã‚¹ãƒˆ
- ç•°ãªã‚‹ã‚µã‚¤ã‚¯ãƒ«æ•°ã§ã®åˆ¤å®šç¢ºèª
- ç•°ãªã‚‹é•·ã„ä¼‘æ†©é–“éš”ã§ã®å‹•ä½œç¢ºèª
- ãƒ•ãƒ«ã‚µã‚¤ã‚¯ãƒ«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

#### 3. çµ±åˆãƒ†ã‚¹ãƒˆ
- ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§ã®é«˜é€Ÿãƒ†ã‚¹ãƒˆ
- å…¨ä¿®æ­£é …ç›®ã®é€£ç¶šãƒ†ã‚¹ãƒˆ

## ğŸ“Š ä¿®æ­£ã®è©³ç´°

### ä¿®æ­£ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
1. `src/background.ts` - GET_STATEãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ‹¡å¼µ
2. `src/popup/popup.ts` - ã‚µã‚¤ã‚¯ãƒ«åŒæœŸã¨ãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£
3. `test-cycle-sync-fix.html` - ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸æ–°è¦ä½œæˆ
4. `CYCLE_SYNC_FIX_LOG.md` - ä¿®æ­£è¨˜éŒ²ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

### ä¿®æ­£ã®å½±éŸ¿ç¯„å›²
- âœ… æ—¢å­˜ã®è¨­å®šå€¤ã«å½±éŸ¿ãªã—
- âœ… æ—¢å­˜ã®æ©Ÿèƒ½ã«ç ´å£Šçš„å¤‰æ›´ãªã—
- âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¸ã®æ‚ªå½±éŸ¿ãªã—

## ğŸ¯ ä¿®æ­£çµæœ

### Beforeï¼ˆä¿®æ­£å‰ï¼‰
- âŒ ã‚µã‚¤ã‚¯ãƒ«æ•°ãŒã€Œ1/4ã€ã®ã¾ã¾é€²è¡Œã—ãªã„
- âŒ é•·ã„ä¼‘æ†©ãŒã€ŒçŸ­ã„ä¼‘æ†©ä¸­ã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹
- âŒ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã¨ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã®çŠ¶æ…‹ä¸ä¸€è‡´

### Afterï¼ˆä¿®æ­£å¾Œï¼‰
- âœ… ã‚µã‚¤ã‚¯ãƒ«æ•°ãŒæ­£å¸¸ã«é€²è¡Œï¼ˆ1/4 â†’ 2/4 â†’ 3/4 â†’ 4/4ï¼‰
- âœ… 4å›ç›®å®Œäº†å¾Œã«ã€Œé•·ã„ä¼‘æ†©ä¸­ã€ã¨é’è‰²è¡¨ç¤º
- âœ… ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã¨ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã®çŠ¶æ…‹åŒæœŸ

## ğŸ” é•·ã„ä¼‘æ†©åˆ¤å®šã®å‹•ä½œä¾‹

### 4å›ã”ã¨ã®å ´åˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
- ã‚µã‚¤ã‚¯ãƒ«1å®Œäº† â†’ çŸ­ã„ä¼‘æ†©
- ã‚µã‚¤ã‚¯ãƒ«2å®Œäº† â†’ çŸ­ã„ä¼‘æ†©
- ã‚µã‚¤ã‚¯ãƒ«3å®Œäº† â†’ çŸ­ã„ä¼‘æ†©
- ã‚µã‚¤ã‚¯ãƒ«4å®Œäº† â†’ **é•·ã„ä¼‘æ†©** âœ…

### 3å›ã”ã¨ã®å ´åˆ
- ã‚µã‚¤ã‚¯ãƒ«1å®Œäº† â†’ çŸ­ã„ä¼‘æ†©
- ã‚µã‚¤ã‚¯ãƒ«2å®Œäº† â†’ çŸ­ã„ä¼‘æ†©
- ã‚µã‚¤ã‚¯ãƒ«3å®Œäº† â†’ **é•·ã„ä¼‘æ†©** âœ…

### 2å›ã”ã¨ã®å ´åˆ
- ã‚µã‚¤ã‚¯ãƒ«1å®Œäº† â†’ çŸ­ã„ä¼‘æ†©
- ã‚µã‚¤ã‚¯ãƒ«2å®Œäº† â†’ **é•·ã„ä¼‘æ†©** âœ…

## ğŸš€ ãƒ‡ãƒãƒƒã‚°åŠ¹ç‡ã®å‘ä¸Š

### ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§ã®ãƒ†ã‚¹ãƒˆæ™‚é–“
- **ä¿®æ­£å‰**: 25åˆ† Ã— 4ã‚µã‚¤ã‚¯ãƒ« = 100åˆ†ï¼ˆ1æ™‚é–“40åˆ†ï¼‰
- **ä¿®æ­£å¾Œ**: 30ç§’ Ã— 4ã‚µã‚¤ã‚¯ãƒ« = 2åˆ†

### ãƒ†ã‚¹ãƒˆåŠ¹ç‡
- 50å€ã®é«˜é€ŸåŒ–
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã®ã‚µã‚¤ã‚¯ãƒ«é€²è¡Œç¢ºèª
- é•·ã„ä¼‘æ†©åˆ¤å®šã®å³åº§ç¢ºèª

## ğŸ”„ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### æ¨å¥¨ã•ã‚Œã‚‹è¿½åŠ æ”¹å–„
1. **ã‚µã‚¤ã‚¯ãƒ«å®Œäº†æ™‚ã®è¦–è¦šåŠ¹æœ** - ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
2. **ã‚µã‚¤ã‚¯ãƒ«çµ±è¨ˆã®è©³ç´°è¡¨ç¤º** - å®Œäº†ã—ãŸã‚µã‚¤ã‚¯ãƒ«æ•°ã®å±¥æ­´
3. **é•·ã„ä¼‘æ†©ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º** - é•·ã„ä¼‘æ†©ã®é »åº¦ã‚’ã‚ˆã‚ŠæŸ”è»Ÿã«è¨­å®š

### ç¶™ç¶šç›£è¦–é …ç›®
- ã‚µã‚¤ã‚¯ãƒ«åŒæœŸã®å®‰å®šæ€§
- é•·ã„ä¼‘æ†©åˆ¤å®šã®æ­£ç¢ºæ€§
- ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§ã®å‹•ä½œç¢ºèª

---

**ä¿®æ­£è€…**: AI Assistant
**ãƒ¬ãƒ“ãƒ¥ãƒ¼**: å®Œäº†
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… 2ã¤ã®å•é¡Œã™ã¹ã¦ä¿®æ­£å®Œäº†
